# SPI

## **Theory**

SPI (Serial Peripheral Interface) is a synchronous communication protocol used primarily for short-distance communication between a microcontroller and peripheral devices such as sensors, memory chips (like EEPROMs and Flash memory), or displays. It operates in a master-slave configuration with four essential lines:

* MOSI (Master Out Slave In): Data sent from the master to the slave.
* MISO (Master In Slave Out): Data sent from the slave to the master.
* SCK (Serial Clock): Clock signal generated by the master to synchronize communication.
* SS (Slave Select): Signal used by the master to select the specific slave to communicate with.

SPI is faster than UART and I2C, making it a popular choice in embedded systems. For pentesters, accessing SPI can lead to reading sensitive data, extracting firmware, or intercepting communications between the main processor and peripheral components.

## **Requirements:**

1. Hardware
   * SPI Interface Adapter (e.g., Bus Pirate, Saleae Logic Analyzer, FTDI-based USB to SPI adapters)
   * Jumper wires
   * Multimeter (for pin identification and voltage checks)
   * Soldering kit (if the SPI interface is not exposed)
2. Software
   * Tools to communicate with SPI:
     * `flashrom` (for reading/writing Flash memory)
     * `spidev` (for interacting with SPI devices in Linux)
     * `Bus Pirate` tools for data sniffing
   * Logic analyzers for reverse engineering SPI communication:
     * `Sigrok` with `PulseView` (for analyzing SPI signals)

## **Usage**

1.  Identifying SPI Pins

    * SPI lines are often not labeled, so identifying them using a multimeter or checking the datasheet of the chip. You can check continuity and voltage levels to identify MOSI, MISO, SCK, and GND.

    Command Example (Bus Pirate for pin identification):

    ```bash
    i  # In Bus Pirate terminal, this will give device and pinout information.
    ```
2.  SPI Flash Dumping

    * SPI flash memory is commonly used in embedded systems for storing firmware. Extracting the contents of SPI flash can provide a copy of the firmware for reverse engineering.

    Command Example (reading SPI Flash with flashrom):

    ```bash
    flashrom -p buspirate_spi:dev=/dev/ttyUSB0,spispeed=1M -r firmware.bin
    ```

    This command reads the flash memory via a Bus Pirate and saves it as `firmware.bin`.
3.  SPI Sniffing (Intercepting Communication)

    * Using a logic analyzer or Bus Pirate, you can sniff the SPI communication between the master and slave to understand the data exchange, including sensitive data like cryptographic keys or firmware updates.

    Command Example (Bus Pirate SPI sniffing):

    ```bash
    (1) m  # Enter SPI mode
    (2) c  # Sniff SPI communication
    ```
4.  Firmware Modification and Flashing

    * After dumping the SPI flash, a pentester can modify the firmware (e.g., by adding a backdoor or modifying configurations) and flash it back to the device.

    Command Example (writing modified firmware):

    ```bash
    flashrom -p buspirate_spi:dev=/dev/ttyUSB0,spispeed=1M -w modified_firmware.bin
    ```

    This writes a modified firmware image back to the device via the SPI interface.

## Resources

[https://www.flashrom.org/supported\_hw/supported\_prog/buspirate.html](https://www.flashrom.org/supported\_hw/supported\_prog/buspirate.html)\
[https://riverloopsecurity.com/blog/2020/02/hw-101-spi/](https://riverloopsecurity.com/blog/2020/02/hw-101-spi/)
